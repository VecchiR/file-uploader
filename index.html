<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="./public/js/contextMenu.js" defer></script>
    <style>
        .person-access {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
        }

        .email {
            min-width: 200px;
        }

        .remove-access {
            border: none;
            background: none;
            color: #666;
            font-size: 18px;
            cursor: pointer;
            padding: 0 5px;
        }

        .remove-access:hover {
            color: #ff0000;
        }

        .expiration-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .set-expiration {
            padding: 4px 8px;
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
        }

        .set-expiration:hover {
            background: #e0e0e0;
        }

        #people-list {
            list-style: none;
            padding: 0;
        }
    </style>
</head>

<body>
    <form action="">
        <h3>Share [filename]</h3>
        <p class="email-error-message" hidden>Some of the emails are invalid: correct them and press "add" again!</p>
        <input id="recipient-emails-input" type="email" multiple placeholder="email1@ex.com, email2@ex.com..." />
        <button type="button" id="add-recipient-btn">Add</button>

        <div class="access-delegation-container">
            <div>
                <h4>People with Access</h4>
                <ul id="recipients-list">
                </ul>
            </div>
            <div>
                <h4>Public Access</h4>
                <select name="public-access-level" id="public-access-level">
                    <option value="private">Private</option>
                    <option value="anyone-with-link">Anyone with the link</option>
                </select>
                <div id="public-access-controls" hidden>
                    <select name="public-role" id="public-role">
                        <option value="viewer">Viewer</option>
                        <option value="editor">Editor</option>
                    </select>
                    <div class="expiration-date-controls">
                        <button type="button" class="set-expiration-btn">Set expiration date</button>
                        <input type="date" name="public-expiration-date" id="public-expiration-date" hidden />
                    </div>
                </div>
            </div>
            <!-- if the user has JavaScript support disabled -->
            <noscript>
                <button type="button">Cancel</button>
                <button type="submit">Share</button>
            </noscript>
        </div>
    </form>

    <script>
        // Handling public access level change (show/hide controls)
        const publicAccessLevel = document.getElementById('public-access-level');
        const publicAccessControls = document.getElementById('public-access-controls');
        publicAccessControls.hidden = publicAccessLevel.value !== 'anyone-with-link';
        publicAccessLevel.addEventListener('change', function (event) {
            publicAccessControls.hidden = event.target.value !== 'anyone-with-link';
        });

  

        // Handle add recipient logic
        const emailErrorMessage = document.querySelector('.email-error-message');
        const addRecipientBtn = document.getElementById('add-recipient-btn');
        const recipientsList = document.getElementById('recipients-list');
        const recipientEmailsInput = document.getElementById('recipient-emails-input');
        addRecipientBtn.addEventListener('click', function () {
            // Allow for multiple e-mails by: splitting the input by commas, trimming spaces, and filtering out empty strings
            const emails = recipientEmailsInput.value.split(',').map(email => email.trim()).filter(email => email);

            // If there are emails, validate them and separate valid and invalid ones
            if (emails.length === 0) {
                emailErrorMessage.hidden = true;
                return;
            }
            const validEmails = [];
            const invalidEmails = [];
            emails.forEach(email => {
                if (isValidEmailAddress(email)) {
                    validEmails.push(email);
                } else {
                    invalidEmails.push(email);
                }
            });

            // Create list items for each valid email
            validEmails.forEach(email => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="person-access">
                        <span class="email">${email}</span>
                        <select class="role">
                            <option value="viewer">Viewer</option>
                            <option value="editor">Editor</option>
                        </select>
                        <div class="expiration-date-controls">
                            <button type="button" class="set-expiration-btn">Set expiration date</button>
                        </div>
                        <button type="button" class="remove-access">Ã—</button>
                    </div>`;
                const removeBtn = li.querySelector('.remove-access');
                removeBtn.addEventListener('click', function () {
                    li.remove();
                });
                recipientsList.appendChild(li);
            });

            // If there are invalid emails, show the error message and populate the input field with them, otherwise hide the error message and clear the input field
            if (invalidEmails.length > 0) {
                emailErrorMessage.hidden = false;
                recipientEmailsInput.value = invalidEmails.join(', ');
            } else {
                emailErrorMessage.hidden = true;
                recipientEmailsInput.value = '';
            }
        });

        // Email validation - creates a temporary input element to leverage the browser's built-in email validation, or falls back to a minimal regex check if the browser does not have that feature.
        function isValidEmailAddress(email) {
            const input = document.createElement('input');
            input.type = 'email';
            input.required = true;
            input.value = email;
            return typeof input.checkValidity === 'function' ? input.checkValidity() : /\S+@\S+\.\S+/.test(email);
        }

        // Event listener for "set expiration date" buttons
        const accessDelegationContainer = document.querySelector('.access-delegation-container');
        accessDelegationContainer.addEventListener('click', function (event) {
            if (event.target.classList.contains('set-expiration-btn')) {
                const btn = event.target;
                const controls = event.target.closest('.expiration-date-controls');
                const dateInput = controls.querySelector('input[type="date"]');

                dateInput.showPicker();

                dateInput.addEventListener('change', function () {
                    if (dateInput.value) {
                        const date = new Date(dateInput.value);
                        btn.textContent = `Expires: ${date}`;
                    }
                    else {
                        btn.textContent = 'Set expiration date';
                    }
                });
            }
        });


    </script>
</body>

</html>